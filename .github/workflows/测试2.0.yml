name: ğŸªŸ æ„å»º astral

on:
   workflow_dispatch:
    inputs:
      repo:
        description: 'è¯·è¾“å…¥astralæºç ä»“åº“'
        required: true
        default: 'cn1095/astral0'
      tag:
        description: 'è¯·è¾“å…¥ä»“åº“åˆ†æ”¯æˆ–ç‰ˆæœ¬å·'
        required: true
        default: 'main'
      flutter:
        description: 'è¯·è¾“å…¥flutterç‰ˆæœ¬å·'
        required: true
        default: '3.24.5'

env:
  CARGO_TERM_COLOR: always
  TZ: Asia/Shanghai
  repo: "${{ github.event.inputs.repo }}"
  tag: "${{ github.event.inputs.tag }}"

jobs:
  build:
    runs-on: windows-latest # ä½¿ç”¨ Windows æœºå™¨è¿è¡Œä»»åŠ¡
    steps:   
      - name: è®¾ç½®Flutterç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ github.event.inputs.flutter }}
          
      - name: æ›¿æ¢ Flutter å¼•æ“ä¸ºæ”¯æŒ Windows 7 çš„ç‰ˆæœ¬
        shell: pwsh
        run: |
          flutter doctor -v
          flutter precache --windows
          Invoke-WebRequest -Uri https://github.com/lmq8267/Toolchain/releases/download/flutter-3.24.5/windows-x64-release.zip -OutFile windows-x64-release.zip
          Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release
          Copy-Item -Path windows-x64-release/* -Destination "C:/hostedtoolcache/windows/flutter/stable-${{ github.event.inputs.flutter }}-x64/bin/cache/artifacts/engine/windows-x64-release/" -Recurse -Force
          Invoke-WebRequest -Uri https://github.com/lmq8267/Toolchain/releases/download/flutter-3.24.5/flutter_3.24.4_dropdown_menu_enableFilter.diff -OutFile flutter_3.24.4_dropdown_menu_enableFilter.diff
          
      - name: æ‰“è¡¥ä¸ä»¥å¯ç”¨ Dropdown Menu è¿‡æ»¤æ”¯æŒ
        shell: bash
        run: |
          cp flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "${{ env.FLUTTER_VERSION }}" == "3.24.5" ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff || true

      - name: å…‹éš†æºç 
        run: git clone -b "${{ env.tag }}" "https://github.com/${{ env.repo }}" C:\astral

      - name: ç¼“å­˜ Cargo å·¥å…·ï¼ˆflutter_rust_bridge_codegen & cargo-expandï¼‰
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.cargo\bin
            C:\Users\runneradmin\.cargo\registry
            C:\Users\runneradmin\.cargo\git
          key: rust-windows-tools-cache-v1

      - name: å®‰è£… flutter_rust_bridge_codegen å’Œ cargo-expand
        shell: pwsh
        run: |
          $Env:CARGO_HOME = "C:\Users\runneradmin\.cargo"   

          if (-not (Test-Path "$Env:CARGO_HOME\bin\flutter_rust_bridge_codegen.exe")) {
            Write-Host "å®‰è£… flutter_rust_bridge_codegen"
            cargo install flutter_rust_bridge_codegen --version 2.8.0
          }

          if (-not (Test-Path "$Env:CARGO_HOME\bin\cargo-expand.exe")) {
            Write-Host "å®‰è£… cargo-expand"
            cargo install cargo-expand
          }

      - name: ç”Ÿæˆflutter_rust_bridge@2.8.0
        shell: bash
        run: |
          cd C:/astral
          rm -rf lib/src/rust/*
          rm rust/src/frb_generated.rs
          echo "å¼€å§‹ç”Ÿæˆflutter_rust_bridge@2.8.0"
          flutter_rust_bridge_codegen generate
          
      - name: æ„å»º Windows astral
        run: |
          set WINVER=0x0601
          setx CARGO_TERM_VERBOSE true
          set CARGO_TERM_VERBOSE=true
          set VERBOSE_SCRIPT=true
          
          cd C:\astral
          flutter pub get
          flutter build windows --release -v
          echo "æ„å»ºå®Œæˆï¼Œå¼€å§‹åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶"
          dir C:\astral\build\windows\x64\runner\Release 
          Copy-Item -Path C:\astral\dlls\* -Destination C:\astral\build\windows\x64\runner\Release -Recurse -Force
          
      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@main
        if: always()
        with:
          name: astral-Windows
          path: C:\astral\build\windows\x64\runner\Release\*
