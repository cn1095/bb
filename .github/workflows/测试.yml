name: ğŸªŸ æ„å»º astral

on:
   workflow_dispatch:
    inputs:
      repo:
        description: 'è¯·è¾“å…¥astralæºç ä»“åº“'
        required: true
        default: 'ldoubil/astral'
      tag:
        description: 'è¯·è¾“å…¥ä»“åº“åˆ†æ”¯æˆ–ç‰ˆæœ¬å·'
        required: true
        default: 'main'

env:
  CARGO_TERM_COLOR: always
  TZ: Asia/Shanghai
  repo: "${{ github.event.inputs.repo }}"
  tag: "${{ github.event.inputs.tag }}"
  FLUTTER_VERSION: 3.24.5

jobs:
  build:
    runs-on: windows-latest # ä½¿ç”¨ Windows æœºå™¨è¿è¡Œä»»åŠ¡
    steps:   
      - name: è®¾ç½®Flutterç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }} 
          
      - name: æ›¿æ¢ Flutter å¼•æ“ä¸ºæ”¯æŒ Windows 7 çš„ç‰ˆæœ¬
        shell: pwsh
        run: |
          flutter doctor -v
          flutter precache --windows
          Invoke-WebRequest -Uri https://github.com/lmq8267/Toolchain/releases/download/flutter-3.24.5/windows-x64-release.zip -OutFile windows-x64-release.zip
          Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release
          Copy-Item -Path windows-x64-release/* -Destination "C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/" -Recurse -Force
          Invoke-WebRequest -Uri https://github.com/lmq8267/Toolchain/releases/download/flutter-3.24.5/flutter_3.24.4_dropdown_menu_enableFilter.diff -OutFile flutter_3.24.4_dropdown_menu_enableFilter.diff
          
      - name: æ‰“è¡¥ä¸ä»¥å¯ç”¨ Dropdown Menu è¿‡æ»¤æ”¯æŒ
        shell: bash
        run: |
          cp flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "${{ env.FLUTTER_VERSION }}" == "3.24.5" ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff || true

      - name: å…‹éš†æºç 
        run: git clone -b "${{ env.tag }}" "https://github.com/${{ env.repo }}" C:\astral

      - name: å®‰è£… Rust å’Œè®¾ç½® toolchain
        run: |
          rustup set auto-self-update disable
          rustup install 1.77
          rustup default 1.77
          rustc --version

      - name: é…ç½® thunk-rs ä¾èµ–å’Œ build.rs æ–‡ä»¶
        shell: pwsh
        run: |
          $cargoPath = "C:\astral\rust\Cargo.toml"
          $buildScriptPath = "C:\astral\rust\build.rs"

          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ build-dependenciesï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ 
          $cargoContent = Get-Content $cargoPath
          if (-not ($cargoContent -match '\[build-dependencies\]')) {
            Add-Content $cargoPath "`n[build-dependencies]"
          }

          # æ·»åŠ  thunk-rs ä¾èµ–ï¼ˆé˜²æ­¢é‡å¤ï¼‰
          if (-not ($cargoContent -match 'thunk-rs')) {
            Add-Content $cargoPath 'thunk-rs = { version = "0.3.3", features = ["win7"] }'
          }

           # å†™å…¥ build.rs æ–‡ä»¶ï¼ˆé€è¡Œå†™å…¥ï¼‰
          Set-Content $buildScriptPath 'fn main() {'
          Add-Content $buildScriptPath '    // é…ç½® thunk-rs æ¥é“¾æ¥ Windows 7 å…¼å®¹åº“ï¼Œå¹¶è‡ªåŠ¨è®¾ç½®é“¾æ¥å‚æ•°'
          Add-Content $buildScriptPath '    thunk::thunk();'
          Add-Content $buildScriptPath '}'
          
      - name: æ„å»º Windows astral
        run: |
          set WINVER=0x0601
          setx CARGO_TERM_VERBOSE true
          set CARGO_TERM_VERBOSE=true
          set VERBOSE_SCRIPT=true
          
          cd C:\astral
          flutter pub get
          flutter build windows --release -v
          echo "æ„å»ºå®Œæˆï¼Œå¼€å§‹åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶"
          dir C:\astral\build\windows\x64\runner\Release
          Copy-Item -Path C:\astral\assets\dlls\* -Destination C:\astral\build\windows\x64\runner\Release -Recurse -Force
          
      - name: ä¸Šä¼ 
        uses: actions/upload-artifact@main
        if: always()
        with:
          name: astral-Windows
          path: C:\astral\build\windows\x64\runner\Release\*
